#!/usr/bin/env bash
set -euo pipefail

echo "================================"
echo " üöÄ Uptime Kuma Terraform deploy"
echo "================================"

# -------------------------------
# 1Ô∏è‚É£ –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ terraform
# -------------------------------
if ! command -v terraform >/dev/null 2>&1; then
  echo "‚ùå Terraform –Ω–µ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–π. –ë—É–¥—å –ª–∞—Å–∫–∞, –≤—Å—Ç–∞–Ω–æ–≤—ñ—Ç—å terraform —ñ –ø–æ–≤—Ç–æ—Ä—ñ—Ç—å —Å–ø—Ä–æ–±—É."
  exit 1
fi

echo "‚úÖ Terraform –∑–Ω–∞–π–¥–µ–Ω–æ: $(terraform -version | head -n 1)"

# -------------------------------
# 2Ô∏è‚É£ –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ terraform.tfvars
# -------------------------------
if [ ! -f terraform.tfvars ]; then
  echo "‚ùå –§–∞–π–ª terraform.tfvars –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–∏–π!"
  echo "‚û°Ô∏è  –°—Ç–≤–æ—Ä—ñ—Ç—å terraform.tfvars –∑ —Ç–∞–∫–∏–º–∏ –∑–º—ñ–Ω–Ω–∏–º–∏:"
  echo 'access_key = "YOUR_AWS_ACCESS_KEY"'
  echo 'secret_key = "YOUR_AWS_SECRET_KEY"'
  exit 1
fi

echo "‚úÖ terraform.tfvars –∑–Ω–∞–π–¥–µ–Ω–∏–π."

# -------------------------------
# 3Ô∏è‚É£ –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è Terraform
# -------------------------------
echo "üîç –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è Terraform..."
terraform init -upgrade

# -------------------------------
# 4Ô∏è‚É£ –ü–ª–∞–Ω—É–≤–∞–Ω–Ω—è
# -------------------------------
echo "üìù –°—Ç–≤–æ—Ä–µ–Ω–Ω—è –ø–ª–∞–Ω—É..."
terraform plan -out=tfplan

# -------------------------------
# 5Ô∏è‚É£ –ü—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
# -------------------------------
read -p "‚úÖ –ó–∞—Å—Ç–æ—Å—É–≤–∞—Ç–∏ —Ü–µ–π –ø–ª–∞–Ω? (yes/no): " confirm
if [[ "$confirm" != "yes" ]]; then
  echo "‚ùå –°–∫–∞—Å–æ–≤–∞–Ω–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–µ–º."
  exit 0
fi

# -------------------------------
# 6Ô∏è‚É£ –ó–∞—Å—Ç–æ—Å—É–≤–∞–Ω–Ω—è
# -------------------------------
echo "üöÄ –ó–∞—Å—Ç–æ—Å—É–≤–∞–Ω–Ω—è –ø–ª–∞–Ω—É..."
terraform apply tfplan

echo "‚úÖ ‚úÖ ‚úÖ –ì–æ—Ç–æ–≤–æ! –Ü–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞ —Å—Ç–≤–æ—Ä–µ–Ω–∞."
